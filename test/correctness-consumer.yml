version: 1.2

consumerId: correctness


input:
  masters:
    - connection:
        address: ${MYSQL_ADDR}
        port: 3306
      scheduler: mod
      repos:
        - name: "test.*"
          entities:
          - name: affair
            fields: [id, name] # default id is not null, other can be null
          - name: file
            fields: [id, name, uploader]
          - name: folder
            fields: [id, name, uploader]
        - name: "simple"
          entities:
          - name: test
            fields: [id, test]


# input result class: com.github.zzt93.syncer.common.data.SyncData
#{
#  repo: xxx
#  entity: xxx
#  id: xid
#  field: {
#    id: xid
#    ...
#  }
#  extra: {
#    ...
#  }
#}

filter:
  - switcher:
      switch: "table"
      case: # support default branch
        "affair": ["#suffix = '-' + row['id']","#type = 'INDEX_AFFAIR'", "renameField('xx', 'yy')" ]
        "file": ["#suffix = '-' + row['id']","#type = 'INDEX_FILE'", "addRow('type', '0')"]
        "folder": ["#suffix = '-' + row['id']","#type = 'INDEX_FILE'", "addRow('type', '1')"]
  - statement: [ "#tags = row['tags']", "updateField('tags', new java.util.ArrayList())", "removeFields('id', 'xid')"]
  - foreach:
      var: "tag"
      in: "#tags?.split('\n')"
      statement: ["#map = new java.util.HashMap()", "#map.put('des', #tag)", "row.get('tags').add(#map)"]
  - if:
      condition: "table == 'affair'"
      ifBody:
        create:
          copy: [row]
          postCreation: ["table = 'role'", "row['id']"]
      elseBody:
        drop: {}

# filter result class: com.github.zzt93.syncer.common.data.SyncData
#{
#  repo: xxx
#  entity: xxx
#  id: xid
#  field: {
#    id: xid
#    ...
#  }
#  extra: {
#    ...
#  }
#}

# Special expression
# "field.*"
# "field.*.flatten"
# "extra.*"
# "extra.*.flatten"

output:
  elasticsearch:
    connection:
      address: ${ES_ADDR}
      port: 9200
    requestMapping: # mapping from input data to es request
      enableExtraQuery: true
      retryOnUpdateConflict: 3
      index: "entity + #suffix" # default: repos
      type: "#docType" # default: entity
      documentId: "id" # default: id
      fieldsMapping: # default: fields.*.flatten
        "fields": "fields.*.flatten"
    batch:
      size: 100
      delay: 1000
      maxRetry: 5
    refreshInMillis: 0
    failureLog:
      countLimit: 1000
